version: "3.9"

services:
  servicea:
    build: ./ServiceA
    ports:
      - "5000:5000"
    environment:
      - SERVICEB_URL=http://serviceb:5001
      - ASPNETCORE_URLS=http://+:5000
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=ServiceA
    depends_on:
      - serviceb
      - otel-collector

  serviceb:
    build: ./ServiceB
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_URLS=http://+:5001
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=ServiceB
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config/otel-collector-config.yaml"]
    volumes:
      # Mount folder (not single file)
      - ./otel-config:/etc/otel-collector-config:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "55681:55681" # OTLP HTTP

  jaeger:
    image: jaegertracing/all-in-one:1.35
    ports:
      - "16686:16686" # UI
      - "9411:9411"   # Zipkin endpoint for OTEL exporter
